name: Push
run-name: ${{ github.ref_name }} push run ðŸš€
on:
  push:
    branches:
      - '*'
    tags:
      - '*'
permissions:
  contents: write
jobs:
  create-windows-update:
    name: 'Fuck. Me.'
    runs-on: windows-2022
    permissions:
      contents: 'read'
      id-token: 'write'
    defaults:
      run:
        shell: pwsh
    environment:
      name: bouf
    steps:
      - uses: actions/checkout@v4
        with:
          path: "repo"
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Set Up Environment ðŸ”§
        id: setup
        run: |
          $channel = if ($env:GITHUB_REF_NAME -match "(beta|rc)") { "beta" } else { "stable" }
          $shortHash = $env:GITHUB_SHA.Substring(0,9)
          "channel=${channel}" >> $env:GITHUB_OUTPUT
          "commitHash=${shortHash}" >> $env:GITHUB_OUTPUT

      - name: Run bouf ðŸ¥©
        uses: ./repo/.github/actions/bouf
        with:
          gcpWorkloadIdentityProvider: ${{ secrets.GCP_IDENTITY_POOL }}
          gcpServiceAccountName: ${{ secrets.GCP_SERVICE_ACCOUNT_NAME }}
          version: ${{ github.ref_name }}
          channel: ${{ steps.setup.outputs.channel }}

      - name: Upload token
        uses: actions/upload-artifact@v4
        with:
          name: jwt-${{ github.ref_name }}
          compression-level: 9
          path: ${{ github.workspace }}/output
